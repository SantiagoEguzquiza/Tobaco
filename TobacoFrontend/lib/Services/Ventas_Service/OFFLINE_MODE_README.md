# üì¥ Sistema de Ventas Offline - Documentaci√≥n Completa

## üìã Descripci√≥n General

Sistema **offline-first** para la gesti√≥n de ventas que permite a los usuarios crear ventas sin conexi√≥n a internet o cuando el backend est√° ca√≠do. Las ventas se guardan localmente en SQLite y se sincronizan autom√°ticamente cuando se restablece la conexi√≥n.

## üéØ Caracter√≠sticas Principales

‚úÖ **Modo Offline Completo**: Crea ventas sin conexi√≥n
‚úÖ **Sincronizaci√≥n Autom√°tica**: Las ventas se env√≠an al servidor cuando hay conexi√≥n
‚úÖ **Sincronizaci√≥n Manual**: Bot√≥n para forzar sincronizaci√≥n
‚úÖ **Manejo de Errores**: Reintento autom√°tico de ventas fallidas
‚úÖ **Base de Datos Local**: SQLite para almacenamiento persistente
‚úÖ **Detecci√≥n de Conectividad**: Monitorea internet y disponibilidad del backend
‚úÖ **UI Informativa**: Widgets visuales del estado de sincronizaci√≥n
‚úÖ **Limpieza Autom√°tica**: Elimina ventas antiguas sincronizadas

## üèóÔ∏è Arquitectura

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           VentasProvider (UI Layer)             ‚îÇ
‚îÇ  - Expone m√©todos a los Screens                ‚îÇ
‚îÇ  - Notifica cambios con ChangeNotifier          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      VentasOfflineService (Business Logic)      ‚îÇ
‚îÇ  - Decide: Online vs Offline                    ‚îÇ
‚îÇ  - Coordina servicios                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ             ‚îÇ              ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇVentas   ‚îÇ  ‚îÇSync       ‚îÇ  ‚îÇConnectivity ‚îÇ
‚îÇService  ‚îÇ  ‚îÇService    ‚îÇ  ‚îÇService      ‚îÇ
‚îÇ(API)    ‚îÇ  ‚îÇ(Sync)     ‚îÇ  ‚îÇ(Monitor)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ  DatabaseHelper    ‚îÇ
         ‚îÇ  (SQLite Local)    ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üìÇ Estructura de Archivos

```
lib/Services/
‚îú‚îÄ‚îÄ Ventas_Service/
‚îÇ   ‚îú‚îÄ‚îÄ ventas_service.dart              # API calls al backend
‚îÇ   ‚îú‚îÄ‚îÄ ventas_offline_service.dart      # L√≥gica offline-first ‚≠ê
‚îÇ   ‚îî‚îÄ‚îÄ ventas_provider.dart             # Provider para UI ‚≠ê
‚îú‚îÄ‚îÄ Connectivity/
‚îÇ   ‚îî‚îÄ‚îÄ connectivity_service.dart        # Monitoreo de conexi√≥n ‚≠ê
‚îú‚îÄ‚îÄ Sync/
‚îÇ   ‚îî‚îÄ‚îÄ sync_service.dart                # Sincronizaci√≥n autom√°tica ‚≠ê
‚îî‚îÄ‚îÄ Cache/
    ‚îî‚îÄ‚îÄ database_helper.dart             # Base de datos SQLite ‚≠ê

lib/Widgets/
‚îî‚îÄ‚îÄ sync_status_widget.dart              # Widgets UI para estado ‚≠ê
```

## üöÄ Configuraci√≥n e Instalaci√≥n

### 1. Dependencias en `pubspec.yaml`

Ya est√°n agregadas:
```yaml
dependencies:
  sqflite: ^2.3.0           # Base de datos local
  path: ^1.8.3              # Manejo de rutas
  connectivity_plus: ^5.0.2  # Detecci√≥n de conectividad
```

### 2. Instalar dependencias

```bash
flutter pub get
```

### 3. Inicializar en `main.dart`

```dart
import 'package:provider/provider.dart';
import 'package:tobaco/Services/Ventas_Service/ventas_provider.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  runApp(
    MultiProvider(
      providers: [
        ChangeNotifierProvider(
          create: (_) => VentasProvider()..initialize(),
        ),
        // ... otros providers
      ],
      child: MyApp(),
    ),
  );
}
```

## üíª Uso en el C√≥digo

### Crear una Venta (Offline-First)

```dart
import 'package:provider/provider.dart';
import 'package:tobaco/Services/Ventas_Service/ventas_provider.dart';
import 'package:tobaco/Services/Ventas_Service/ventas_offline_service.dart';

// En tu screen de nueva venta
Future<void> _guardarVenta() async {
  final ventasProvider = Provider.of<VentasProvider>(context, listen: false);
  
  // Crear objeto venta
  final venta = Ventas(
    clienteId: _cliente.id!,
    cliente: _cliente,
    ventasProductos: _productos,
    total: _calcularTotal(),
    fecha: DateTime.now(),
    metodoPago: _metodoPago,
    usuarioId: _usuarioActual.id,
  );

  try {
    // ‚≠ê Este m√©todo maneja autom√°ticamente online/offline
    final result = await ventasProvider.crearVenta(venta);
    
    if (result.success) {
      if (result.isOffline) {
        // Venta guardada offline
        _mostrarMensaje(
          '‚úÖ Venta guardada localmente. Se sincronizar√° cuando haya conexi√≥n.',
          Colors.orange,
        );
      } else {
        // Venta creada online
        _mostrarMensaje('‚úÖ Venta creada exitosamente', Colors.green);
      }
      
      Navigator.pop(context);
    } else {
      _mostrarMensaje('‚ùå Error: ${result.message}', Colors.red);
    }
  } catch (e) {
    _mostrarMensaje('‚ùå Error: $e', Colors.red);
  }
}
```

### Mostrar Estado de Sincronizaci√≥n

```dart
import 'package:tobaco/Widgets/sync_status_widget.dart';

// En tu screen principal o de ventas
@override
Widget build(BuildContext context) {
  return Scaffold(
    appBar: AppBar(
      title: Text('Ventas'),
      actions: [
        // Badge en la barra de navegaci√≥n
        SyncStatusBadge(),
        SizedBox(width: 16),
      ],
    ),
    body: Column(
      children: [
        // Widget de estado detallado
        SyncStatusWidget(showDetails: true),
        
        // Resto del contenido
        Expanded(
          child: _buildVentasList(),
        ),
      ],
    ),
  );
}
```

### Sincronizaci√≥n Manual

```dart
// Bot√≥n para sincronizar manualmente
ElevatedButton(
  onPressed: () async {
    final provider = Provider.of<VentasProvider>(context, listen: false);
    
    final result = await provider.sincronizarAhora();
    
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(result.message),
        backgroundColor: result.success ? Colors.green : Colors.red,
      ),
    );
  },
  child: Text('Sincronizar Ventas'),
)
```

### Monitorear Estado de Conexi√≥n

```dart
import 'package:provider/provider.dart';

// En tu widget
Widget build(BuildContext context) {
  return Consumer<VentasProvider>(
    builder: (context, ventasProvider, child) {
      final isConnected = ventasProvider.isConnected;
      final pendientes = ventasProvider.ventasPendientes;
      final fallidas = ventasProvider.ventasFallidas;
      
      return Column(
        children: [
          // Indicador de conexi√≥n
          Container(
            color: isConnected ? Colors.green : Colors.red,
            padding: EdgeInsets.all(8),
            child: Text(
              isConnected ? '‚úÖ Conectado' : '‚ùå Sin conexi√≥n',
              style: TextStyle(color: Colors.white),
            ),
          ),
          
          // Estad√≠sticas
          if (pendientes > 0)
            Text('üìã $pendientes ventas pendientes de sincronizaci√≥n'),
          if (fallidas > 0)
            Text('‚ö†Ô∏è $fallidas ventas con errores'),
        ],
      );
    },
  );
}
```

## üîÑ Flujo de Funcionamiento

### 1. Crear Venta con Conexi√≥n

```
Usuario crea venta
    ‚Üì
¬øHay conexi√≥n? ‚Üí S√≠
    ‚Üì
Enviar al backend
    ‚Üì
¬ø√âxito? ‚Üí S√≠
    ‚Üì
‚úÖ Venta creada online
```

### 2. Crear Venta sin Conexi√≥n

```
Usuario crea venta
    ‚Üì
¬øHay conexi√≥n? ‚Üí No
    ‚Üì
Guardar en SQLite local
    ‚Üì
‚úÖ Venta guardada offline
    ‚Üì
(Cuando hay conexi√≥n)
    ‚Üì
Sincronizaci√≥n autom√°tica
    ‚Üì
Enviar al backend
    ‚Üì
‚úÖ Venta sincronizada
```

### 3. Error en Sincronizaci√≥n

```
Intento de sincronizaci√≥n
    ‚Üì
‚ùå Error (timeout, 500, etc.)
    ‚Üì
Marcar como "failed"
    ‚Üì
Incrementar contador de intentos
    ‚Üì
Esperar pr√≥ximo ciclo de sync
    ‚Üì
(Usuario puede forzar reintento)
```

## üóÑÔ∏è Esquema de Base de Datos SQLite

### Tabla: `ventas_offline`

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| `id` | INTEGER | ID autoincremental local |
| `local_id` | TEXT | ID √∫nico local (ej: `local_1698765432000`) |
| `cliente_id` | INTEGER | ID del cliente |
| `cliente_json` | TEXT | JSON completo del cliente |
| `total` | REAL | Total de la venta |
| `fecha` | TEXT | Fecha ISO8601 |
| `sync_status` | TEXT | Estado: `pending`, `synced`, `failed` |
| `sync_attempts` | INTEGER | N√∫mero de intentos de sincronizaci√≥n |
| `error_message` | TEXT | Mensaje de error si falla |
| `created_at` | TEXT | Fecha de creaci√≥n |
| `updated_at` | TEXT | √öltima actualizaci√≥n |

### Tabla: `ventas_productos_offline`

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| `id` | INTEGER | ID autoincremental |
| `venta_local_id` | TEXT | FK a ventas_offline |
| `producto_id` | INTEGER | ID del producto |
| `nombre` | TEXT | Nombre del producto |
| `cantidad` | REAL | Cantidad vendida |
| `precio` | REAL | Precio unitario |
| `precio_final_calculado` | REAL | Precio con descuentos |

## üìä Estados de Sincronizaci√≥n

| Estado | Descripci√≥n | Acci√≥n |
|--------|-------------|--------|
| `pending` | Pendiente de enviar | Se sincronizar√° autom√°ticamente |
| `synced` | Sincronizada exitosamente | Se puede limpiar despu√©s de 30 d√≠as |
| `failed` | Fall√≥ la sincronizaci√≥n | Se puede reintentar manualmente |

## ‚öôÔ∏è Configuraci√≥n Avanzada

### Cambiar Intervalo de Sincronizaci√≥n

En `sync_service.dart`:
```dart
// Cambiar de 5 minutos a otro intervalo
_syncTimer = Timer.periodic(Duration(minutes: 10), (timer) async {
  // ...
});
```

### Cambiar D√≠as de Retenci√≥n

```dart
// Limpiar ventas sincronizadas despu√©s de 60 d√≠as
await ventasProvider.limpiarVentasAntiguas(dias: 60);
```

### Endpoint de Health Check

El `connectivity_service.dart` verifica la disponibilidad del backend en:
```
GET /api/health
```

**Necesitas agregar este endpoint en tu backend:**

```csharp
// En tu TobacoApi
[ApiController]
[Route("api/[controller]")]
public class HealthController : ControllerBase
{
    [HttpGet]
    public IActionResult Get()
    {
        return Ok(new { status = "healthy" });
    }
}
```

## üêõ Troubleshooting

### Problema: Ventas no se sincronizan

**Soluci√≥n:**
1. Verificar que el backend tenga el endpoint `/api/health`
2. Verificar conectividad en el dispositivo
3. Ver logs en consola para errores espec√≠ficos
4. Intentar sincronizaci√≥n manual

### Problema: Error "Database is locked"

**Soluci√≥n:**
- SQLite solo permite una escritura a la vez
- El sistema ya maneja esto con transacciones
- Si persiste, reiniciar la aplicaci√≥n

### Problema: Ventas duplicadas

**Soluci√≥n:**
- El sistema previene duplicados con `local_id` √∫nico
- Si una venta se sincroniza, se marca como `synced`
- No se volver√° a enviar

## üì± Ejemplo Completo de Implementaci√≥n

Ver el archivo `nuevaVenta_screen.dart` para un ejemplo completo de uso en una pantalla real.

## üé® Personalizaci√≥n de UI

### Colores del Widget de Estado

Editar `sync_status_widget.dart`:
```dart
Color _getBackgroundColor(int pendientes, int fallidas, bool isConnected) {
  if (fallidas > 0) return Colors.red.shade700;      // Error
  if (pendientes > 0 && !isConnected) return Colors.orange.shade700;  // Offline
  if (pendientes > 0 && isConnected) return Colors.blue.shade700;     // Sincronizando
  return Colors.green.shade700;  // Todo OK
}
```

## üîê Consideraciones de Seguridad

- ‚úÖ Los tokens de autenticaci√≥n se incluyen en cada sincronizaci√≥n
- ‚úÖ Los datos locales est√°n en el sandbox de la app
- ‚ö†Ô∏è Para datos muy sensibles, considerar encriptaci√≥n de SQLite
- ‚úÖ Las ventas offline usan el mismo modelo que online

## üìà M√©tricas y Monitoreo

```dart
// Obtener estad√≠sticas
final stats = await ventasProvider.obtenerEstadisticas();

print('Total: ${stats['total']}');
print('Pendientes: ${stats['pending']}');
print('Fallidas: ${stats['failed']}');
print('Sincronizadas: ${stats['synced']}');
```

## üöÄ Pr√≥ximas Mejoras

- [ ] Encriptaci√≥n de base de datos local
- [ ] Resoluci√≥n de conflictos si se edita la misma venta online/offline
- [ ] Soporte para editar ventas offline
- [ ] Sincronizaci√≥n diferencial (solo cambios)
- [ ] Compresi√≥n de datos antes de sincronizar

## üìû Soporte

Para preguntas o problemas, consultar:
- Logs de consola con prefijos: `üîÑ`, `üíæ`, `üì°`, `‚úÖ`, `‚ùå`
- Documentaci√≥n de servicios individuales en sus archivos
- Error Handler Guide: `lib/Services/ERROR_HANDLING_GUIDE.md`

---

**¬°El sistema est√° listo para funcionar 100% offline! üéâ**

